<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.infStudy.lectureMapper">
   
   <insert id="addLecture" parameterType="kr.co.infStudy.model.LectureVO">
   		INSERT INTO LECTURE(L_NO, I_NO, CTG_NO, TITLE, PRICE, RANK, DIFFICULTY, IMG, REL_DT)
   		VALUES(LECTURE_SEQ.NEXTVAL, #{i_no}, #{ctg_no}, #{title}, #{price}, #{rank}, #{difficulty}, #{img, jdbcType=VARCHAR}, SYSDATE)
   </insert>
   
	<select id="getLectureInfo" parameterType="java.util.HashMap" resultType="kr.co.infStudy.dto.lecture.LectureDTO">
		
			select lec_t.title, lec_t.content, lec_t.price, lec_t.img, ctg_t.name as category, ins_t.name as teacher
			from lecture lec_t, instructor ins_t, category ctg_t
			where lec_t.i_no = ins_t.i_no and lec_t.ctg_no = ctg_t.ctg_no 
			
			<if test="category_name != null">
				and ctg_t.name = #{category_name}
			</if>
			
			<if test="sort == 'price'">
				order by lec_t.price
			</if>
   </select>

	<select id="getLectureDetail" parameterType="java.lang.String" resultType="kr.co.infStudy.dto.lecture.LectureDetailDTO">
	<![CDATA[	
	SELECT L_T.L_NO, L_T.TITLE AS LECTURE_TITLE, I_T.NAME AS TEACHER, L_T.IMG, 
	      (SELECT AVG(RANK) FROM REVIEW WHERE L_NO =(SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS RANK_AVG,
	      (SELECT COUNT(*) FROM REVIEW WHERE L_NO = (SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS REVIEW_CNT, 
	      (SELECT COUNT(*) FROM PAID_LEC WHERE L_NO = (SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS STUDENT_CNT,
	      CTG_T.NAME AS CATEGORY, L_T.PRICE, L_T.DIFFICULTY,
	      (SELECT COUNT(*) FROM CURRICULUM WHERE L_NO = (SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS CURRICULUM_CNT, 
	      (SELECT SUM(PLAYTIME) FROM CURRICULUM WHERE L_NO = (SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS TOTAL_RUNTIME,
	      (SELECT COUNT(*) FROM WISH_LIST WHERE L_NO = (SELECT L_NO FROM LECTURE WHERE TITLE = #{lecture_title})) AS WISHLIST_CNT
	FROM LECTURE L_T, INSTRUCTOR I_T, CATEGORY CTG_T 
	WHERE L_T.I_NO = I_T.I_NO AND L_T.CTG_NO = CTG_T.CTG_NO AND L_T.TITLE = #{lecture_title}
	]]>
   </select>
   
   <select id="select" resultType="kr.co.infStudy.model.LectureVO">
   
   </select>
   
   <update id="update" parameterType="kr.co.infStudy.model.LectureVO">
   
   </update>
   
   <delete id="delete" parameterType="kr.co.infStudy.model.LectureVO">
   
   </delete>
</mapper>